<tool id="immunopheno_normalization" name="ImmunoPheno Normalization">
    <description>Normalizes CITE-seq data and generates UMAPs</description>
    
    <requirements>
        <requirement type="package" version="3.9">python</requirement>
        <requirement type="package" version="0.1.8">lincolnwu::immunopheno</requirement>
        <requirement type="package">pandas</requirement>
        <requirement type="package">scanpy</requirement>
        <requirement type="package">umap-learn</requirement>
        <requirement type="package">matplotlib-base</requirement>
        <requirement type="package">graphviz</requirement>
        <requirement type="package">python-graphviz</requirement>
        <requirement type="package">scikit-learn</requirement>
    </requirements>
    
    <command detect_errors="aggressive"><![CDATA[
        python '${__tool_directory__}/normalization.py'
            --model '${model}'
            --output_csv "normalized_counts.csv"
            --umap "umap.png"

            #if $input_mode.input_type == "csv":
                --protein "${input_mode.protein}"
                #if $input_mode.rna:
                    --rna "${input_mode.rna}"
                #end if
                #if $input_mode.labels:
                    --labels "${input_mode.labels}"
                #end if
            #else:
                --scanpy_path "${input_mode.scanpy_path}"
                #if str($input_mode.scanpy_labels) != '':
                    --scanpy_labels "${input_mode.scanpy_labels}"
                #end if
            #end if

            --sig_expr_threshold ${adv.sig_expr_threshold}
            --bg_expr_threshold ${adv.bg_expr_threshold}
            
            --bg_cell_z_score ${adv.bg_cell_z_score}
    ]]></command>
    
    <inputs>
        <conditional name="input_mode">
            <param name="input_type" type="select" label="Select your input data format">
                <option value="csv" selected="true">From CSV files</option>
                <option value="scanpy">From Scanpy (h5ad) file</option>
            </param>
            <when value="csv">
                <param name="protein" type="data" format="csv" label="Protein Counts CSV File"/>
                <param name="rna" type="data" format="csv" optional="true" label="RNA Counts CSV File (Optional)"/>
                <param name="labels" type="data" format="csv" optional="true" label="Cell Labels CSV File (Optional)"/>
            </when>
            <when value="scanpy">
                <param name="scanpy_path" type="data" format="h5ad" label="Scanpy AnnData File"/>
                <param name="scanpy_labels" type="text" optional="true" label="Labels field name in Scanpy object (Optional)" 
                help="e.g., cell_type"/>
            </when>
        </conditional>
        <param name="model" type="select" label="Mixture Model for Normalization">
            <option value="nb" selected="true">Negative Binomial</option>
            <option value="gaussian">Gaussian</option>
        </param>
        <section name="adv" title="Advanced Normalization Parameters" expanded="true">
            <param name="sig_expr_threshold" type="float" value="1.0" label="Signal Expression Threshold"
                   help="Cells with a percentage of expressed proteins above this threshold are filtered out."/>
            <param name="bg_expr_threshold" type="float" value="0.0" label="Background Expression Threshold"
                   help="Cells with a percentage of expressed proteins below this threshold are filtered out."/>
            <!-- <param name="p_threshold" type="float" value="0.05" label="P-value Threshold"/> -->
            <param name="bg_cell_z_score" type="float" value="10.0" label="Background Cell Z-score"
                   help="Number of standard deviations of average protein expression to separate antibody expressing
                   cells from non-expressing cells. A larger value will result in more discrete clusters in the normalized 
                    protein expression UMAP space."/>
        </section>
    </inputs>
    
    <outputs>
        <data name="output_csv" format="csv" from_work_dir="normalized_counts.csv" label="Normalized Counts on ${on_string}"/>
        <data name="output_umap" format="png" from_work_dir="umap.png" label="UMAP Plots on ${on_string}"/>
    </outputs>
    
    <help><![CDATA[
        This tool normalizes protein expression data from CITE-seq experiments using the ImmunoPheno `normalize_all_antibodies` function.

        **Inputs**

        You can provide data in two ways:

        - **CSV Files:** Provide a CSV of protein counts (cells as rows, proteins as columns). You can optionally provide matching RNA counts and cell labels.
        - **Scanpy/AnnData File:** Provide a single `.h5ad` file. Protein counts should be in `.obsm['protein_expression']`.

        **CSV File Formats**

        **Protein CSV:** A CSV file containing the raw counts, where the rows are cells and columns are protein markers.

        - For example, the protein CSV should look like:

            +------------------------+------------+----------+------------+----------+------------+----------+ 
            |                        | CD11a                 | CD3                   | CD56                  |
            +========================+============+==========+============+==========+============+==========+
            | cell_barcode_1         | 3                     | 0                     | 2                     |
            +------------------------+------------+----------+------------+----------+------------+----------+
            | cell_barcode_2         | 6                     | 4                     | 0                     |
            +------------------------+-----------------------+-----------------------+-----------------------+
            | cell_barcode_3         | 10                    | 52                    | 32                    |
            +------------------------+-----------------------+-----------------------+-----------------------+


        **RNA CSV (optional):** A CSV file containing the scRNA-seq (transcript count), where the rows are cells and columns are genes.
        The rows must match those found in the protein data.

        - For example, the RNA CSV should look like:

            +------------------------+------------+----------+------------+----------+------------+----------+ 
            |                        | Gene1                 | Gene2                 | Gene3                 |
            +========================+============+==========+============+==========+============+==========+
            | cell_barcode_1         | 0                     | 0                     | 2                     |
            +------------------------+------------+----------+------------+----------+------------+----------+
            | cell_barcode_2         | 1                     | 3                     | 0                     |
            +------------------------+-----------------------+-----------------------+-----------------------+
            | cell_barcode_3         | 7                     | 0                     | 0                     |
            +------------------------+-----------------------+-----------------------+-----------------------+
        
        **Cell Label CSV (optional):** A CSV file containing cell labels/annotations for each cell, where the rows are cells and there
        exists at least one column named "celltype". This will label populations on the UMAP. The rows must match those found in the protein data. 

        - For example, the cell labels CSV should look like:

            +------------------------+------------+----------+
            |                        | celltype              |
            +========================+============+==========+
            | cell_barcode_1         | naive B cell          |
            +------------------------+------------+----------+
            | cell_barcode_2         | monocyte              |
            +------------------------+-----------------------+
            | cell_barcode_3         | natural killer cell   |
            +------------------------+-----------------------+


        **Outputs**

        The tool produces two files:

        1. CSV File with normalized counts
        2. PNG image containing UMAP plots of the raw and normalized data


        **Tutorial**

        A tutorial on using this tool can be found in ImmunoPheno's documentation: https://immunopheno.readthedocs.io/en/main/galaxy_normalization.html.

    ]]></help>

</tool>